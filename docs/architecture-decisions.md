# 架构决策记录 (Architecture Decision Records)

## 🎯 文档概述

本文档记录了 CampusRide 后端项目的关键架构决策，包括技术选型、模块划分、设计模式等重要决定。每个决策都包含背景、考虑的选项、最终决定和理由。

## 📋 目录

1. [模块划分策略](#模块划分策略)
2. [技术栈选择](#技术栈选择)
3. [数据库设计原则](#数据库设计原则)
4. [API 设计规范](#api设计规范)
5. [安全架构](#安全架构)
6. [性能优化策略](#性能优化策略)
7. [部署架构](#部署架构)

---

## 🏗️ 模块划分策略

### ADR-001: 双模块并行开发架构

**状态**: 已采纳  
**日期**: 2024-01-15  
**决策者**: 技术团队

#### 背景

项目需要在短时间内开发完整的校园拼车平台，需要两名开发者并行工作。

#### 考虑的选项

1. **垂直划分**: 按功能模块完整划分（每人负责从前端到后端）
2. **水平划分**: 按技术层划分（一人前端，一人后端）
3. **混合划分**: 按业务领域划分后端，共享前端

#### 决策

采用**混合划分**方案：

- **Cursor AI**: 负责核心服务与交易型模块（基础架构、用户认证、拼车、市场）
- **Claude Code**: 负责社交与参与型模块（活动、积分、排行榜、实时通信）

#### 理由

1. 明确的职责边界，减少冲突
2. 允许并行开发，提高效率
3. 模块间通过明确的 API 接口通信
4. 便于独立测试和部署

#### 影响

- 需要严格的接口契约管理
- 需要完善的集成测试
- 需要良好的文档和沟通机制

---

## 💻 技术栈选择

### ADR-002: Node.js + Express 作为后端框架

**状态**: 已采纳  
**日期**: 2024-01-16

#### 决策

- **运行时**: Node.js 18+ LTS
- **框架**: Express.js 4.x
- **语言**: JavaScript (考虑未来迁移到 TypeScript)

#### 理由

1. 团队熟悉度高
2. 生态系统成熟
3. 异步性能优秀
4. 适合实时通信需求

### ADR-003: PostgreSQL 作为主数据库

**状态**: 已采纳  
**日期**: 2024-01-16

#### 决策

- **主数据库**: PostgreSQL 15+
- **扩展**: PostGIS (地理位置)
- **ORM**: Prisma

#### 理由

1. ACID 事务支持，确保数据一致性
2. PostGIS 提供强大的地理位置功能
3. 性能优秀，扩展性好
4. 支持复杂查询和索引

### ADR-004: 使用 Supabase 作为后端服务

**状态**: 已采纳  
**日期**: 2024-01-17

#### 决策

使用 Supabase 提供：

- 用户认证服务
- 实时数据订阅
- 存储服务
- Row Level Security (RLS)

#### 理由

1. 减少开发工作量
2. 内置的安全功能
3. 良好的扩展性
4. 实时功能开箱即用

---

## 🗄️ 数据库设计原则

### ADR-005: 数据库表职责划分

**状态**: 已采纳  
**日期**: 2024-01-18

#### 决策

**Cursor AI 负责的表**：

- users (用户基础信息)
- vehicles (车辆信息)
- trips (行程信息)
- bookings (预订信息)
- marketplace_items (商品信息)
- item_favorites (收藏)
- reviews (评价)

**Claude Code 负责的表**：

- activities (活动)
- activity_participants (参与者)
- point_rules (积分规则)
- user_points (用户积分)
- point_transactions (积分交易)
- messages (消息)
- notifications (通知)

#### 理由

1. 与模块职责对应
2. 减少跨模块的数据库依赖
3. 便于独立开发和测试

### ADR-006: 使用 UUID 作为主键

**状态**: 已采纳  
**日期**: 2024-01-18

#### 决策

所有表使用 UUID 作为主键，而非自增整数。

#### 理由

1. 避免 ID 冲突
2. 提高安全性（ID 不可预测）
3. 便于分布式扩展
4. 支持离线数据生成

---

## 🔌 API 设计规范

### ADR-007: RESTful API + 实时 WebSocket

**状态**: 已采纳  
**日期**: 2024-01-19

#### 决策

- **常规操作**: RESTful API
- **实时功能**: Socket.io
- **API 版本**: URL 路径版本控制 (/api/v1)

#### 理由

1. REST 适合 CRUD 操作
2. WebSocket 适合实时通信
3. 清晰的版本管理策略

### ADR-008: 统一响应格式

**状态**: 已采纳  
**日期**: 2024-01-19

#### 决策

所有 API 响应采用统一格式：

```json
{
  "success": true/false,
  "data": {},
  "error": {
    "code": "ERROR_CODE",
    "message": "Error description"
  },
  "meta": {}
}
```

#### 理由

1. 前端处理一致
2. 错误处理标准化
3. 便于调试和监控

---

## 🔒 安全架构

### ADR-009: JWT 认证 + Row Level Security

**状态**: 已采纳  
**日期**: 2024-01-20

#### 决策

- **认证**: JWT (通过 Supabase Auth)
- **授权**: RLS 策略
- **中间件**: 统一的 authMiddleware

#### 理由

1. 无状态认证，易于扩展
2. 数据库级别的安全保障
3. 减少应用层的安全逻辑

### ADR-010: 环境变量管理

**状态**: 已采纳  
**日期**: 2024-01-20

#### 决策

- 使用.env 文件管理环境变量
- 提供.env.example 模板
- 敏感信息永不提交到代码库

#### 理由

1. 安全性考虑
2. 便于不同环境配置
3. 标准化的配置管理

---

## ⚡ 性能优化策略

### ADR-011: 缓存策略

**状态**: 计划中  
**日期**: 2024-01-21

#### 决策

- **缓存层**: Redis
- **缓存内容**: 用户信息、排行榜、热门活动
- **缓存时间**: 根据数据类型设定

#### 理由

1. 减少数据库压力
2. 提高响应速度
3. 支持分布式缓存

### ADR-012: 数据库查询优化

**状态**: 已采纳  
**日期**: 2024-01-21

#### 决策

- 为常用查询字段建立索引
- 使用数据库连接池
- 避免 N+1 查询问题
- 使用分页限制结果集大小

#### 理由

1. 提高查询性能
2. 减少资源消耗
3. 保证系统稳定性

---

## 🚀 部署架构

### ADR-013: 容器化部署

**状态**: 计划中  
**日期**: 2024-01-22

#### 决策

- 使用 Docker 容器化
- docker-compose 用于本地开发
- Kubernetes 用于生产部署

#### 理由

1. 环境一致性
2. 易于扩展
3. 便于 CI/CD 集成
4. 资源隔离

### ADR-014: 监控和日志

**状态**: 计划中  
**日期**: 2024-01-22

#### 决策

- **日志**: Winston + 日志聚合
- **监控**: Prometheus + Grafana
- **错误追踪**: Sentry

#### 理由

1. 全面的系统可观测性
2. 快速定位问题
3. 性能监控和预警

---

## 📝 决策记录模板

```markdown
### ADR-XXX: [决策标题]

**状态**: 提议中/已采纳/已弃用/被 XXX 取代  
**日期**: YYYY-MM-DD  
**决策者**: [姓名/团队]

#### 背景

[描述需要做出决策的背景和问题]

#### 考虑的选项

1. **选项 1**: [描述]
   - 优点:
   - 缺点:
2. **选项 2**: [描述]
   - 优点:
   - 缺点:

#### 决策

[描述最终的决策]

#### 理由

[解释为什么选择这个方案]

#### 影响

[描述这个决策的影响和需要注意的事项]
```
